# 통합 시나리오

이 문서는 편집을 지원하는 전체 시나리오를 포함하는 진행 중인 문서입니다.

> **참고**: 전체 시나리오가 개별 랩으로 롤백되면 제거됩니다.

## LAB_AK_01

### 랩 시나리오

Contoso라는 선두적인 고급 치즈 회사에서 Azure IoT 개발자로 근무하고 있습니다. Contoso는 IoT의 비즈니스 기회를 평가한 후 상당한 이점이 있다는 결론을 내렸습니다. 평가를 토대로 Microsoft Azure IoT를 선택했습니다.

시작하려면 Azure 도구에 익숙해져야 합니다.

#### 연습 1: Azure Portal 및 대시보드 살펴보기

Azure IoT 서비스를 사용하기 전에 Azure 자체의 작동 방식에 익숙해지는 것이 좋습니다.

일반적으로 Azure를 '클라우드'라고 부르지만 실제로는 단일 웹 사이트에서 Azure 리소스에 액세스할 수 있도록 설계된 웹 포털입니다. 모든 Azure 리소스는 Azure Portal을 통해 액세스할 수 있습니다.

#### 연습 2: Azure 대시보드 및 리소스 그룹 만들기

Azure Portal에서 대시보드는 리소스의 사용자 지정 보기를 표시하는 데 사용됩니다. 유용한 방법으로 리소스를 구성하는 데 도움이 되는 배열과 크기를 조정할 수 있는 타일을 사용하여 정보가 표시됩니다. 다양한 보기를 제공하고 다양한 용도로 사용할 수 있는 수많은 대시보드를 만들 수 있습니다.

대시보드에 배치하는 각 타일은 하나 이상의 리소스를 노출합니다. 개별 리소스의 데이터를 노출하는 타일 외에도 리소스 그룹이라는 곳에 타일을 만들 수 있습니다.

리소스 그룹은 프로젝트 또는 애플리케이션 관련 리소스를 포함하는 논리 그룹입니다. 리소스 그룹에는 솔루션에 대한 모든 리소스를 포함하거나 그룹으로 관리하려는 리소스만 포함할 수 있습니다. 조직에 가장 적합하게끔 리소스 그룹에 리소스를 할당하는 방법을 여러분이 결정합니다. 일반적으로, 수명 주기가 같은 리소스를 동일한 리소스 그룹에 추가하여, 이를 한 그룹으로 간편하게 배포, 업데이트, 삭제할 수 있습니다.

다음 작업에서는 다음을 수행합니다.

* 이 과정에서 사용할 수 있는 사용자 지정 대시보드 만들기
* 리소스 그룹을 만들고 대시보드에 리소스 그룹 타일을 추가

## LAB_AK_02

### 랩 시나리오

치즈를 생산하고 유통하는 Contoso에서 Azure IoT 개발자로 근무하고 있습니다. 회사에서 구현할 IoT 솔루션에 사용할 Azure 및 Azure IoT 서비스를 조사하는 업무가 주어졌습니다. Azure Portal에 익숙해졌으며, 프로젝트에 리소스 그룹을 만들었습니다. 이제 Azure IoT 서비스에 대해 조사해야 합니다.

#### 연습 1: 리소스에 고유한 이름 지정

이 과정 전반에 걸쳐 리소스를 만 것입니다. 랩 전체의 일관성을 보장하고 랩을 완료할 때마다 리소스를 정리하는 데 도움이 되도록 사용해야 할 이름이 제공됩니다. 그러나, 이러한 리소스 중 상당수는 웹에서 사용할 수 있는 서비스를 노출하므로 전역적으로 고유한 이름을 가져야 합니다. 이를 위해 리소스 이름 끝에 추가할 고유 식별자를 사용합니다. 고유 ID를 만들어 보겠습니다.

#### 연습 2: Azure Portal을 사용하여 IoT Hub 만들기

Azure IoT Hub는 IoT 디바이스와 Azure 간의 안정적이고 안전한 양방향 통신을 가능하게 하는, 완전 관리형 서비스입니다. Azure IoT Hub 서비스는 다음을 제공합니다.

* 수십억 개의 IoT 디바이스로 양방향 통신 구축
* 단방향 메시지, 파일 전송 및 요청-회신 방법을 비롯한 여러 가지 디바이스-클라우드 및 클라우드-디바이스 통신 옵션.
* 기본 제공 선언적 메시지를 다른 Azure 서비스로 라우팅.
* 디바이스 메타데이터 및 동기화된 상태 정보에 대한 쿼리 가능한 저장소.
* 디바이스별 보안 키 또는 X.509 인증서를 사용한 보안 통신 및 액세스 제어.
* 디바이스 연결 및 디바이스 ID 관리 이벤트에 대한 광범위한 모니터링.
* 가장 많이 사용되는 언어와 플랫폼에 대한 SDK 디바이스 라이브러리.

IoT Hub를 만드는 데 사용할 수 있는 몇 가지 방법이 있습니다. 예를 들어, Azure Portal을 사용하여 IoT Hub 리소스를 만들 수 있으며, 이 작업에서 수행하게 됩니다. 그러나, 프로그래밍 방식으로도 IoT Hub(및 기타 리소스)를 만들 수 있습니다. 이 과정에서는 Azure CLI 및 PowerShell 등 Azure 리소스를 만들고 관리하는 방법을 추가로 알아봅니다.

#### 연습 3: IoT Hub 서비스 검토

이미 알고 있듯이, IoT Hub는 클라우드에서 호스팅되는 관리 서비스이며, IoT 애플리케이션과 관리하는 장치 간의 양방향 통신을 위한 중앙 메시지 허브 역할을 합니다.

IoT Hub의 기능을 사용하면 제조에 사용되는 산업용 장비의 관리, 의료 분야의 귀중한 자산 추적, 사무용 건물 사용 모니터링과 같은 확장성과 모든 기능을 갖춘 IoT 솔루션을 구축할 수 있습니다. IoT Hub 모니터링을 사용하면 디바이스 만들기, 디바이스 오류, 디바이스 연결과 같은 이벤트를 추적하여 솔루션의 상태를 유지 관리할 수 있습니다.

#### 연습 4: Azure Portal을 사용하여 디바이스 프로비저닝 서비스 만들기

Azure IoT Hub Device Provisioning Service는 사람의 개입 없이 적절한 IoT 허브에 제로 터치, Just-In-Time 프로비저닝을 가능하게 하는 IoT Hub용 도우미 서비스입니다. 디바이스 프로비저닝 서비스는 다음을 제공합니다.

* 공장에서 IoT Hub 연결 정보를 하드코딩하지 않고 단일 IoT 솔루션에 제로 터치 프로비저닝(초기 설정)
* 여러 허브에서 디바이스 부하 분산
* 판매 트랜잭션 데이터를 기반으로 디바이스를 소유자의 IoT 솔루션에 연결(다중 테넌트 지원)
* 사용 사례에 따라 디바이스를 특정 IoT 솔루션에 연결(솔루션 격리)
* 디바이스를 대기 시간이 가장 적은 IoT Hub에 연결(지리적 분할)
* 디바이스 변경사항에 따라 다시 프로비저닝
* 디바이스에서 IoT Hub에 연결하는 데 사용하는 키 롤링(연결 시 X.509 인증서를 사용하지 않는 경우)

IoT Hub Device Provisioning Service의 인스턴스를 만드는 방법에는 몇 가지가 있습니다. 예를 들어, Azure Portal을 쓸 수 있는데 이 작업 중에 사용해 볼 것입니다. 그러나, Azure CLI 또는 Azure Resource Manager 템플릿을 사용하여 DPS 인스턴스를 만들 수도 있습니다.

#### 연습 5: 디바이스 프로비저닝 서비스 검토

IoT Hub Device Provisioning Service는 IoT Hub를 위한 도우미 서비스로서, 사람의 개입 없이도 적절한 IoT 허브에 제로 터치, Just-In-Time 프로비저닝을 지원하여 고객이 수백만 대의 디바이스를 안전하고 확장 가능한 방식으로 프로비저닝할 수 있습니다.

## LAB_AK_03

### 랩 시나리오

Contoso의 개발자로서, Azure IoT 솔루션을 빌드하기 전에 개발 환경을 설정하는 것이 중요하다는 것을 알고 있습니다. Microsoft는 IoT 솔루션을 개발하고 지원하기 위한 여러 가지 도구를 제공하고 있으며, 팀에서는 어떤 도구를 사용할 것인지 결정해야 한다는 사실을 알고 계십니다. 팀에서 Azure 클라우드 측과 로컬 작업 환경 모두에서 IoT 솔루션을 개발하는 데 사용할 수 있는 작업 환경을 준비합니다.

논의 후 팀에서 개발 환경에 대해 다음과 같은 높은 수준의 결정을 내렸습니다.

* 운영 체제: Windows 10을 OS로 사용합니다. Windows는 팀의 대부분에서 사용되므로 합리적인 선택이었습니다. Azure IoT 서비스는 Mac OS 및 Linux와 같은 다른 운영 체제를 지원하며, Microsoft는 이러한 대안 중 하나를 선택하는 팀의 구성원에게 도움이 되는 설명서를 제공합니다.
* 일반 코딩 도구: Visual Studio Code 및 Azure CLI를 기본 코딩 도구로 사용합니다. 이 두 도구는 Azure IoT SDK를 활용하는 IoT용 확장 프로그램을 지원합니다.
* IoT Edge 도구: Docker 데스크톱 커뮤니티와 Python은 사용자 지정 IoT Edge 모듈 개발을 지원하는 데 사용됩니다.

이러한 결정을 지원하기 위해 다음과 같은 환경을 설정합니다.

* Windows 10 64비트: Pro, Enterprise 또는 Education(빌드 15063 이상). 포함 내용:
  * 4GB – 8GB 시스템 RAM(클수록 Docker에 더 유리)
  * Windows의 Hyper-V 및 컨테이너 기능을 사용하도록 설정해야 합니다.
  * BIOS 수준의 하드웨어 가상화 지원은 BIOS 설정에서 활성화되어야 합니다.

  > **참고**: 가상 머신에서 개발 환경을 설정할 때 VM 환경은 중첩 가상화를 지원해야 합니다 - [중첩 가상화](https://docs.microsoft.com/ko-kr/virtualization/hyper-v-on-windows/user-guide/nested-virtualization)

* Azure CLI(현재/최신)
* .NET Core 3.0.100(이상) SDK
* VS Code(최신)
* Python 3.7(3.8 아님)
* Linux 컨테이너에 설정된 Docker Desktop 커뮤니티 2.1.0.5(이상)
* Power BI Desktop(데이터 시각화용)
* VS Code 및 Azure CLI용 IoT 확장 프로그램

> **참고**: 위에서 언급한 대부분의 도구를 제공하는 이 과정에 가상 머신이 만들어졌습니다. 아래 지침은 준비된 VM을 사용하거나 PC를 사용하여 로컬로 개발 환경을 설정하는 것을 지원합니다.

#### 연습 1: 개발자 도구 및 제품 설치

> **참고**: 이 연습과 연관된 도구 및 제품은 이 과정을 위해 만든 가상 머신에 미리 설치되어 있습니다. 계속하기 전에 과정 강사에게 문의하여 호스팅된 랩 VM 환경을 사용하여 랩을 완료하는지 혹은 PC에서 로컬로 개발 환경을 설정할지 여부를 확인하세요.

#### 연습 2: 개발 도구 확장 프로그램 설치

Visual Studio Code 및 Azure CLI 도구는 개발자가 솔루션을 보다 효율적으로 만들 수 있도록 도와주는 확장 프로그램을 지원합니다. Microsoft는 IoT SDK를 활용하고 개발 시간을 단축하는 IoT용 확장 프로그램을 개발했습니다.

#### 연습 3: 과정 랩 파일 및 대체 도구 설정

이 과정의 랩 중 상당수는 랩 작업의 시작점으로 사용할 수 있는 코드 프로젝트 등과 같이 미리 빌드된 리소스에 의존합니다. GitHub 프로젝트를 사용하여 이러한 랩 리소스에 액세스할 수 있도록 해줍니다. 과정 랩을 직접 지원하는 리소스(GitHub 프로젝트에 포함된 리소스) 외에도, 실제 과정 밖에서도 학습 기회를 지원하는 데 사용할 수 있는 도구가 있습니다. 아래 지침은 이러한 두 리소스 유형의 구성을 알려줍니다.

## LAB_AK_04

### 랩 시나리오

Contoso는 고품질 치즈를 생산하는 곳으로 유명합니다. Contoso는 인기와 판매량이 급격히 성장함에 따라 고객이 기대하는 수준의 치즈 품질을 유지하도록 조치를 취하려고 합니다.

과거에는 각 근무 교대 근무 시 공장 작업자가 온도와 습도 데이터를 수집했습니다. Contoso는 새로운 시설이 온라인으로 전환되면 공장 확장에 따라 모니터링이 증가하고 데이터 수동 수집 프로세스를 조정하지 못할 수도 있다고 걱정하고 있습니다.

Contoso는 IoT 디바이스를 사용하여 온도와 습도를 모니터링하는 자동화 시스템을 도입하기로 결정했습니다. 원격 분석 데이터가 전달되는 속도는 치즈가 환경적으로 민감한 공정을 통과할 때 생산 공정이 제어되도록 조정할 수 있습니다.

본격적으로 구현하기 전에 이 자산 모니터링 솔루션을 평가하기 위해 온도와 습도 센서 등 IoT 디바이스를 IoT Hub에 연결합니다.

#### 연습 1: 랩 필수 구성 요소 확인

이 랩은 다음 Azure 리소스를 사용할 수 있다고 가정합니다.

| 리소스 종류 | 리소스 이름 |
| :-- | :-- |
| 리소스 그룹 | AZ-220-RG |
| IoT Hub | AZ-220-HUB-_{YOUR-ID}_ |

#### 연습 2: Azure CLI를 사용하여 Azure IoT Hub 디바이스 ID 만들기

`iot` Azure CLI 모듈에는 `az iot hub device-identity` 명령 그룹의 Azure IoT Hub 내에서 IoT 디바이스를 관리하는 명령이 몇 가지 포함되어 있습니다. 이러한 명령은 스크립트 내에서 또는 명령줄/터미널에서 직접 IoT 디바이스를 관리할 때 사용할 수 있습니다.

#### 연습 3: 시뮬레이션된 디바이스 구성 및 테스트(C#)

이 연습에서는 이전 연습에서 만든 디바이스 ID 및 공유 선택 키를 사용하여 Azure IoT Hub에 연결하도록 C#으로 작성된 시뮬레이션된 디바이스를 구성합니다. 그런 다음, 디바이스를 테스트하고 IoT Hub가 예상대로 디바이스에서 원격 분석을 수신하고 있는지 확인합니다.

## LAB_AK_05

### 랩 시나리오

Contoso 경영진은 IoT 디바이스를 사용하여 현재 시스템에서 요구하는 수동 데이터 입력 작업을 줄이고 배송 중에 더욱 뛰어난 모니터링을 제공하는 자산 모니터링 및 추적 솔루션을 업데이트하고자 합니다. 이 솔루션은 IoT 디바이스를 프로비저닝하고 프로비저닝 해제하는 기능에 의존합니다. 프로비저닝 요구 사항을 관리하는 가장 좋은 옵션은 DSP인 것으로 판단됩니다.

제안된 시스템은 운송 중 배송 컨테이너의 위치, 온도, 압력을 추적하기 위해 통합 센서가 있는 IoT 디바이스를 사용합니다. 디바이스는 Contoso가 치즈를 운반하는 데 사용하는 기존 배송 컨테이너에 부착되며, 차량 WiFi를 사용하여 Azure IoT Hub에 연결됩니다. 새 시스템은 제품 환경을 지속적으로 모니터링하고 문제가 감지되었을 때 다양한 알림 시나리오를 가능하게 해줍니다.

Contoso의 치즈 포장 시설에서 빈 컨테이너가 시스템에 입력되면 새로운 IoT 디바이스가 장착된 후 포장된 치즈 제품이 적재됩니다. IoT 디바이스는 디바이스 프로비저닝 서비스를 사용하여 IoT Hub에 자동 프로비전되어야 합니다. 컨테이너가 목적지에 도착하면 IoT 디바이스를 회수한 후 DPS를 통해 "서비스 해제"됩니다. 이 디바이스는 이후의 배송품에 다시 사용됩니다.

DPS를 사용하여 디바이스 프로비저닝 및 프로비저닝 취소 프로세스의 유효성을 검사해야 하는 임무를 받았습니다. 프로세스의 초기 단계에서는 개별 등록 방법을 사용합니다.

#### 연습 1: 랩 필수 구성 요소 확인

이 랩은 다음 Azure 리소스를 사용할 수 있다고 가정합니다.

| 리소스 종류 | 리소스 이름 |
| :-- | :-- |
| 리소스 그룹 | AZ-220-RG |
| IoT Hub | AZ-220-HUB-_{YOUR-ID}_ |
| 디바이스 프로비저닝 서비스 | AZ-220-DPS-_{YOUR-ID}_ |

#### 연습 2: DPS에서 새 개별 등록(대칭 키) 만들기

이 연습에서는 _대칭 키 증명_을 사용하여 DPS(디바이스 프로비저닝 서비스)에 있는 디바이스에 새 개별 등록을 만듭니다.

#### 연습 3: 시뮬레이션된 디바이스 구성

이 연습에서는 이전에서 만든 개별 등록계약을 사용하여 Azure IoT에 연결하기 위해 C#으로 작성된 시뮬레이션 디바이스를 구성합니다. 또한 Azure IoT Hub에 있는 디바이스 쌍에 따라 디바이스 구성을 읽고 업데이트하는 시뮬레이션 디바이스에 코드를 추가합니다.

이 연습에서 만든 시뮬레이션된 디바이스는 운송 컨테이너/상자에 있는 IoT 디바이스를 나타내며, 운송하는 동안 Contoso 제품을 모니터링하기 위해 사용합니다. Azure IoT Hub로 전송되는 디바이스의 센서 원격 분석에는 컨테이너의 온도와 습도, 압력, 위도/경도 좌표가 포함됩니다. 이 디바이스는 전체 자산 추적 솔루션의 일부입니다.

이전에는 시뮬레이션된 디바이스가 Azure에 연결된 랩에서 공유 선택키를 사용하여 인증하였으므로 디바이스 프로비저닝이 필요하지 않았고 따라서 프로비저닝 관리 이점(예: 디바이스 쌍)을 누릴 수 없을 뿐 아니라 공유 키를 상당히 많이 배포하고 관리해야 했습니다. 그러나 이번 랩은 이전 랩과는 다릅니다.  이 랩에서는 디바이스 프로비저닝 서비스를 통해 고유한 디바이스를 프로비전합니다.

#### 연습 4: 시뮬레이션된 디바이스 테스트

이 연습에서는 시뮬레이션된 디바이스를 실행하고 Azure IoT Hub로 센서 원격 분석을 보내는지 확인합니다. 또한, Azure IoT Hub 내에서 시뮬레이션된 디바이스에 대한 디바이스 쌍 업데이트를 통해 원격 분석이 Azure IoT Hub로 전송되는 지연을 업데이트합니다.

#### 연습 5: 디바이스 사용 중지

이 단원에서는 DPS(디바이스 프로비저닝 서비스) 및 Azure IoT Hub에서 디바이스를 사용 중지하는 데 필요한 작업을 수행합니다. Azure IoT 솔루션에서 IoT 디바이스를 완전히 사용 중지하려면 두 서비스 모두에서 제거해야 합니다. 운송 상자가 최종 목적지에 도착하면 센서가 상자에서 제거되고 "서비스 해제"되어야 합니다. 완전하게 디바이스를 사용 중지하는 것은 IoT 솔루션 내의 IoT 디바이스의 수명 주기에서 중요한 단계입니다.

## LAB_AK_06

### 랩 시나리오

Contoso의 자산 모니터링 및 추적 솔루션에 대한 최신 작업을 통해 개별 등록을 사용하여 디바이스 프로비저닝 및 프로비저닝 해제 프로세스의 유효성을 검사할 수 있습니다. 지금 관리 팀이 프로세스를 더 큰 규모로 롤아웃하도록 요청했습니다.

프로젝트를 계속 진행하려면 X.509 인증서 인증을 사용하여 더 많은 수의 디바이스를 자동으로 안전하게 등록하는 데 디바이스 프로비저닝 서비스를 사용할 수 있다는 것을 입증해야 합니다.

#### 연습 1: 랩 필수 구성 요소 확인

이 랩은 다음 Azure 리소스를 사용할 수 있다고 가정합니다.

| 리소스 종류 | 리소스 이름 |
| :-- | :-- |
| 리소스 그룹 | AZ-220-RG |
| IoT Hub | AZ-220-HUB-_{YOUR-ID}_ |
| 디바이스 프로비저닝 서비스 | AZ-220-DPS-_{YOUR-ID}_ |

#### 연습 2: OpenSSL을 사용하여 X.509 CA 인증서 생성 및 구성

이 연습에서는 Azure Cloud Shell 내에서 OpenSSL을 사용하여 X.509 CA 인증서를 생성합니다. 이 인증서는 DPS(디바이스 프로비저닝 서비스) 내에서 그룹 등록계약을 구성하는 데 사용합니다.

#### 연습 3: DPS에서 그룹 등록계약(X.509 인증서) 만들기

이 연습에서는 _인증서 증명_을 사용하여 DPS(디바이스 프로비저닝 서비스)에 있는 디바이스에 새 개별 등록계약을 만듭니다.

#### 연습 4: X.509 인증서로 시뮬레이션된 디바이스 구성

이 연습에서는 X.509 인증서를 사용하여 DPS(디바이스 프로비저닝 서비스)를 통해 Azure IoT Hub에 연결하도록 C#으로 작성된 시뮬레이션된 디바이스를 구성합니다. 이 연습에서는 `/LabFiles` 디렉터리에 있는 **시뮬레이션된 디바이스** 소스 코드의 워크플로와 DPS로 인증하고 IoT Hub로 메시지를 보내는 방법도 소개합니다.

#### 연습 5: 디바이스 쌍의 필요한 속성 변경 처리

이 연습에서는 Azure IoT Hub에서 디바이스로 전송된 디바이스 쌍의 필요한 속성 변경 내용을 기반으로 디바이스 구성을 업데이트하는 이벤트 처리기를 포함하도록 시뮬레이션된 디바이스 소스 코드를 수정합니다.

디바이스 쌍은 메타데이터, 구성 및 조건 등 디바이스 상태 정보를 저장하는 JSON 문서입니다. Azure IoT Hub는 IoT Hub에 연결하는 각 디바이스를 디바이스 쌍으로 유지 관리합니다.

DPS(디바이스 프로비저닝 서비스)에는 그룹 등록을 사용하여 등록된 디바이스에 초기 디바이스 쌍의 필요한 속성이 포함되어 있습니다. 디바이스를 등록하면 DPS에 있는 이 초기 디바이스 쌍 구성을 사용하여 IoT Hub 내에 디바이스가 만들어집니다. 등록 후 Azure IoT Hub는 IoT Hub 디바이스 레지스트리 내의 각 디바이스에 대해 디바이스 쌍(및 해당 속성)을 유지 관리합니다.

Azure IoT Hub에 있는 디바이스에 대해 디바이스 쌍의 필요한 속성이 업데이트되면 C# SDK를 사용하여 `DesiredPropertyUpdateCallback` 이벤트로 필요한 변경 내용이 IoT 디바이스로 전송됩니다. 디바이스 코드에서 이 이벤트를 처리하면 Azure IoT Hub 내의 디바이스에 대한 디바이스 쌍 상태를 쉽게 관리하여 디바이스 구성과 속성을 원하는 대로 업데이트할 수 있습니다.

이 단계들은 개념과 프로세스가 동일하기 때문에 시뮬레이션된 디바이스로 작업하기 위한 이전 랩의 단계와 매우 유사합니다.  프로비저닝 프로세스의 인증에 사용되는 방법은 디바이스가 프로비전된 후 디바이스 쌍 속성 변경 내용의 전달을 변경하지 않습니다.

#### 연습 6: 시뮬레이션된 디바이스 테스트

이 연습에서는 시뮬레이션된 디바이스를 실행합니다. 디바이스가 처음 시작되면 DPS(디바이스 프로비저닝 서비스)에 연결되고 구성된 그룹 등록을 사용하여 자동으로 등록됩니다. DPS 그룹 등록에 등록하면 Azure IoT Hub 디바이스 레지스트리에 디바이스가 자동으로 등록됩니다. 등록되면 디바이스는 구성된 X.509 인증서 인증을 사용하여 Azure IoT Hub와 안전하게 통신합니다.

#### 연습 7: 그룹 등록계약 폐기

이 연습에서는 디바이스 프로비저닝 서비스 및 Azure IoT Hub에서 등록계약 그룹과 디바이스를 모두 사용 중지합니다.

## LAB_AK_07

### 랩 시나리오

Contoso 경영진은 자동 디바이스 등록 구현에 깊은 인상을 받았으며, 이제 비즈니스 가치를 제공할 수 있는 시나리오를 검토할 준비가 되었습니다.

모든 치즈 제조사의 핵심은 포장하고 고객에게 치즈를 배송하는 것입니다. 비용 효율성을 극대화하기 위해 Contoso는 온-프레미스 포장 시설을 운영하고 있습니다. 워크플로는 간단합니다. 배송을 위해 패키지를 조립한 다음, 컨베이어 벨트에 실려서 배송함으로 이동합니다. 성공의 척도는 컨베이어 벨트를 떠나는 패키지의 수입니다.

컨베이어 벨트는 공정에서 중요한 연결 고리이며, 진동이 모니터링됩니다. 컨베이어 벨트에는 정지, 느림, 빠름의 세 가지 속도가 있습니다. 느린 속도로 배송되는 패키지 수는 더 빠른 속도의 패키지 수보다 적지만, 진동은 느린 속도에서 감소합니다. 진동이 과도해지면 컨베이어 벨트를 중지하고 검사해야 합니다.

여러 가지 유형의 진동이 있습니다. 강제 진동은 외부 힘에 의한 진동입니다. 예를 들면, 고장난 바퀴 또는 컨베이어 벨트에 잘못 놓인 무거운 패키지와 같은 힘입니다. 또한 설계 한도를 초과할 때 발생하기도 하는 증가하는 진동이 있습니다.

진동은 일반적으로 가속도(미터 매 초 제곱, m/s&#x00B2;)로 측정합니다.

여기서 궁극적인 목표는 예방적 유지 보수입니다. 손상이 발생하기 전에 문제를 감지합니다. 

> **참고**: **예방 유지 보수**(예방적 유지 보수라고도 함)는 장비가 정상적으로 작동하는 동안 수행되도록 유지 보수 활동을 예약하는 장비 유지 보수 프로그램입니다. 이 방법의 목적은 비싼 대가를 지불하는 중단 사태를 초래하는 예기치 않은 고장을 방지하는 것입니다.

비정상적인 진동 수준을 감지하는 것이 항상 쉬운 것은 아닙니다. 이러한 이유로 데이터 이상을 감지하는 Azure IoT Hub를 검토하고 있습니다. 컨베이어 벨트에 진동 감지 센서를 사용하여 IoT Hub로 연속 원격 분석을 전송할 계획입니다. IoT Hub는 Azure Stream Analytics 및 기본 제공 ML(기계 학습) 모델을 사용하여 진동 이상에 대해 사전 경고를 보냅니다. 또한, 필요한 경우를 대비하여 모든 원격 분석 데이터를 보관할 계획입니다.

처음에는 시뮬레이션된 원격 분석을 사용하여 계획된 시스템의 프로토타입을 만들기로 결정했습니다.

#### 연습 1: 랩 필수 구성 요소 확인

이 랩에서 다음 리소스를 사용할 수 있다고 가정합니다.

| 리소스 종류 | 리소스 이름 |
| :-- | :-- |
| 리소스 그룹 | AZ-220-RG |
| IoT Hub | AZ-220-HUB-_{YOUR-ID}_ |
| 디바이스 ID | VibrationSensorId |

#### 연습 2: 진동 원격 분석용 코드 작성

컨베이어 벨트를 모니터링하는 핵심은 진동 원격 분석의 출력입니다. 진동은 일반적으로 가속도(m/s&#x00B2;)로 측정되지만, 때로는 중력(1g = 9.81m/s&#x00B2;)으로도 측정됩니다. 진동에는 3가지 유형이 있습니다.

* 자연 진동은 구조물이 진동하는 빈도입니다.
* 자유 진동은 구조물에 충격이 가해졌을 때 발생하지만 간섭 없이 진동하도록 내버려 둡니다.
* 강제 진동: 구조물이 약간의 압력을 받았을 때 발생합니다.

강제 진동은 컨베이어 벨트에 위험한 진동입니다. 이 진동은 낮은 수준에서 시작하더라도 구조물이 조기에 내려 앉도록 할 수 있습니다. 컨베이어 벨트 작동 시 자유 진동이 발생하는 경우는 적습니다. 아시다시피, 대부분의 기계에는 자연 진동이 있습니다.

작성할 코드 샘플은 다양한 속도(정지, 느림, 빠름)로 작동되는 컨베이어 벨트를 시뮬레이션합니다. 벨트가 빨리 작동할수록 더 많은 패키지가 배송되지만 진동의 영향을 더 많이 받게 됩니다. 무작위로 사인파를 토대로 자연 진동을 추가합니다. 변칙 검색 시스템은 이 사인파의 급상승이나 급하락을 변칙으로 잘못 식별할 수 있습니다. 그런 다음, 두 가지 형태의 강제 진동을 추가합니다. 첫 번째는 진동이 주기적으로 증가하는 효과가 있습니다(아래 이미지 참조). 두 번째로 증가 진동에서는 사이파가 추가되고 처음에는 작지만 점점 증가합니다.

컨베이어 벨트에 하나의 센서 디바이스(시뮬레이션된 IoT 디바이스)가 있다고 가정합니다. 센서는 진동 데이터를 통신하는 것 외에도 다른 데이터(전달된 패키지, 주변 온도 및 유사한 메트릭)도 전송합니다. 이 랩의 경우 추가 값이 스토리지 아카이브로 전송됩니다.

이 연습 동안 이 랩의 거의 모든 코딩이 완성됩니다. Visual Studio Code를 사용하여 C#으로 시뮬레이터 코드를 작성합니다.

이 연습에서는 다음을 수행합니다.

* 컨베이어 벨트 시뮬레이터 구축
* 이전 단원에서 만든 IoT Hub로 원격 분석 메시지 보내기

이 랩의 후반부에서는 소량의 SQL 코딩을 완성합니다.

#### 연습 3: Azure Blob Storage에 대한 메시지 라우팅 만들기

진동 모니터링 시스템의 아키텍처는 스토리지와 분석이라는 두 가지 목적지로 데이터를 전송해야 합니다. Azure IoT는 *메시지 라우팅*을 통해 정확한 서비스로 데이터를 전달하는 훌륭한 방법을 제공합니다.

이 시나리오에서는 다음 두 가지 경로를 만들어야 합니다.

* 첫 번째 라우팅은 데이터를 보관하는 스토리지입니다.
* 두 번째 라우팅은 변칙 검색을 위한 이벤트 허브로 이동합니다.

메시지 라우팅은 한 번에 하나씩 만들고 테스트하는 것이 가장 좋기 때문에 이 연습에서는 스토리지 라우팅에 중점을 두겠습니다. 이 라우팅을 "로깅" 라우팅이라고 하며, Azure 리소스를 만들기 위한 몇 가지 단계를 자세히 살펴보는 작업이 포함됩니다. 이 라우팅을 만드는 데 필요한 모든 기능은 Azure Portal에 있습니다.

스토리지 라우팅을 단순하게 유지하고 Azure Blob Storage를 사용합니다(Data Lake Storage도 사용할 수 있음). 메시지 라우팅의 핵심 기능은 수신 데이터의 필터링입니다. SQL로 작성된 필터는 특정 조건이 충족될 때만 라우팅 아래로 출력됩니다.

데이터를 필터링하는 가장 쉬운 방법 중 하나는 메시지 속성에 있으므로 코드에 이 두 줄을 추가했습니다.

```csharp
...
telemetryMessage.Properties.Add("sensorID", "VSTel");
...
loggingMessage.Properties.Add("sensorID", "VSLog");
```

메시지 라우팅에 포함된 SQL 쿼리는 `sensorID` 값을 테스트할 수 있습니다.

이 연습에서는 로깅 라우팅을 만들고 테스트합니다.

#### 연습 4: 로깅 라우팅 Azure Stream Analytics 작업

로깅 라우팅이 예상대로 작동하는지 확인하기 위해 Azure Portal의 Storage Explorer를 사용하여 유효성을 검사할 수 있는 Blob Storage로 로깅 메시지를 라우팅하는 Stream Analytics 작업을 만듭니다.

이렇게 하면 라우팅에 다음 설정이 포함되어 있는지 확인할 수 있습니다.

* **이름** - vibrationLoggingRoute
* **데이터 원본** - DeviceMessages
* **라우팅 쿼리** - sensorID = "VSLog"
* **엔드포인트** - vibrationLogEndpoint
* **활성화됨** - 참

> **참고**: 데이터를 스토리지로 라우팅한 다음 Azure Stream Analytics를 통해 스토리지로 다시 보내는 것이 이상하게 보일 수 있습니다.  프로덕션 시나리오에서는 두 경로 모두 장기적으로 사용할 수 없습니다.  대신, 여기서 만드는 두 번째 경로는 존재하지 않습니다.  여기서는 Azure Stream Analytics를 랩 환경에서 쉽게 검증할 수 있는 방식으로 시연하기 위한 용도로 사용하고 있습니다.

## LAB_AK_08

### 랩 시나리오

패키지 가져와 우편함에 떨어뜨리는 컨베이어 벨트 시스템의 진동 데이터와 기타 원격 분석 출력을 생성하는 디바이스 시뮬레이터를 개발했습니다. Azure Blob Storage로 데이터를 보내는 로깅 라우팅을 만들고 테스트했습니다.

이벤트 허브는 Stream Analytics의 편리한 입력이기 때문에 두 번째 라우팅은 이벤트 허브로 이동합니다. Stream Analytics는 시나리오에서 찾고 있는 과도한 진동과 같은 변칙 검색을 처리하는 편리한 방법입니다.

이 라우팅은 IoT Hub를 위해 생성된 다음 Azure Stream Analytics 작업에 대한 입력으로 추가됩니다.

두 개의 입력과 두 개의 출력, 그리고 좀 더 복잡한 쿼리를 처리하도록 작업을 업데이트해야 합니다.

두 번째 라우팅을 만드는 프로세스는 엔드포인트를 만들 때 달라지지만 첫 번째 라우팅과 유사한 프로세스를 따릅니다. 이벤트 허브는 원격 분석 라우팅의 엔드포인트로 선택됩니다.

이 연습에서는 이벤트 허브 *네임스페이스*를 만듭니다. 그런 다음, 네임스페이스의 *인스턴스*를 만들어 이벤트 허브 설정을 완료해야 합니다. 그런 다음, 이 인스턴스를 새 메시지 라우팅의 대상으로 사용할 수 있습니다.

라우팅을 만든 후 쿼리 업데이트로 이동합니다.

#### 기본 제공 기계 학습 모델 호출

호출하려는 기본 제공 ML(기계 학습) 함수는 `AnomalyDetection_SpikeAndDip`입니다.

`AnomalyDetection_SpikeAndDip` 함수는 데이터의 슬라이딩 창을 가져와 이상 징후가 없는지 검사합니다. 슬라이딩 창은 가장 최근의 2분 간의 원격 분석 데이터일 수 있습니다. 이 슬라이딩 창은 원격 분석의 흐름을 거의 실시간으로 따라갑니다. 슬라이딩 창의 크기가 증가하면 일반적으로 변칙 검색의 정확도도 증가합니다. 대기 시간도 마찬가지입니다.

데이터 흐름이 계속되면 알고리즘은 정상 값 범위를 설정한 다음 새 값을 정상 값과 비교합니다. 결과는 각 값에 대한 점수 즉, 주어진 값이 변칙적인 신뢰도를 결정하는 백분율입니다. 낮은 신뢰도는 무시되며, 문제는 어느 정도 비율의 신뢰 값이 허용되느냐입니다. 쿼리에서 이 티핑 포인트를 95%로 설정합니다.

데이터에 차이가 있을 때(컨베이어 벨트가 잠시 멈춘 경우)와 같이 항상 문제가 있습니다. 알고리즘은 대체 값으로 대체하여 데이터의 빈 공간을 처리합니다.

> **참고**: 통계에서 대체는 누락된 데이터를 대체 값으로 대체하는 작업입니다. 대체에 대한 자세한 내용은 [여기서](https://en.wikipedia.org/wiki/Imputation_%28statistics%29) 확인할 수 있습니다.

원격 분석 데이터의 급상승과 급하락은 일시적인 이상입니다. 그러나, 진동 사인파를 다루고 있기 때문에 짧은 기간의 "정상" 값이 이상 경고를 트리거하는 높거나 낮은 값을 따를 수 있습니다. 운영자가 짧은 시간 동안 발생하는 이상 징후 클러스터를 찾고 있습니다. 이러한 클러스터는 문제가 있음을 나타냅니다.

추세를 감지하는 모델 등 다른 기본 제공 ML 모델이 있습니다. 이 모듈의 일부로 이러한 모델을 포함하지는 않지만 학생들에게 추가 조사를 권장합니다.

#### Power BI를 사용하여 데이터 시각화

수치 데이터(특히 양)를 시각화하는 것 자체가 과제입니다. 무엇이 잘못되었는지 추론하는 일련의 이상 징후를 운영자에게 어떻게 알릴 수 있습니까?

이 모듈에서 사용하는 솔루션은 Azure Stream Analytics의 기능과 함께 Power BI의 일부 기본 제공 기능을 사용하여 Power BI가 수집할 수 있는 실시간 형식으로 데이터를 전송합니다.

Power BI의 대시보드 기능을 사용하여 여러 개의 타일을 만듭니다. 하나의 타일에는 실제 진동 측정값이 포함되어 있습니다. 또 다른 타일은 값이 변칙적인 신뢰도를 0.0~1.0으로 표시하는 게이지입니다. 세 번째 타일은 95% 신뢰도에 도달했는지 여부를 나타냅니다. 마지막으로, 네 번째 타일은 지난 한 시간 동안 감지된 이상 징후의 수를 표시합니다. 시간을 x축으로 포함시킴으로써, 이 타일은 가로로 함께 클러스터될 때 이상 현상의 클러치가 짧은 시간 동안 연속으로 감지되었는지를 분명하게 알 수 있습니다.

네 번째 타일을 사용하면 원격 분석 콘솔 창의 빨간색 텍스트와 이상 징후를 비교할 수 있습니다. 강제 진동 또는 증가하는 진동 또는 이 두 개의 진동이 모두 발생할 경우 감지되는 이상 징후 클러스터가 있습니까?

이벤트 허브를 만들고, 두 번째 경로를 만들고, SQL 쿼리를 업데이트하고, Power BI 대시보드를 만든 뒤 전부 실행해 보겠습니다!

#### 연습 1: PowerBI 등록

Power BI는 개인 데이터 분석 및 시각화 도구가 될 수 있으며 그룹 프로젝트, 부서 또는 기업 전체의 분석과 의사 결정 엔진 역할을 할 수도 있습니다. 이 랩의 후반부에 PowerBI를 사용하여 대시보드를 만들고 데이터를 시각화합니다. 이 연습에서는 Power BI를 개인으로 등록하는 방법을 설명합니다.

>**참고:** PowerBI 구독이 이미 있는 경우 다음 단계로 건너뛸 수 있습니다.

#### 연습 2: 랩 필수 구성 요소 확인

대시보드에서 데이터를 시각화하려면 실시간 원격 분석이 필요합니다. 이 연습에서는 이전 랩의 디바이스 시뮬레이터 앱이 실행되고 있는지 확인합니다.

#### 연습 3: Azure 이벤트 허브 라우팅 및 이상 쿼리 추가

이제 IoT Hub로 원격 분석 데이터를 스트리밍하므로 솔루션에 Azure 이벤트 허브 네임스페이스 및 Azure 이벤트 허브 인스턴스를 추가합니다. Azure Event Hubs는 스트리밍 데이터를 처리하는 데 이상적이며, 라이브 대시보드 시나리오를 지원하여 진동 데이터를 Power BI로 전달하는 데 적합합니다.

#### 연습 4: 실시간 메시지 라우팅 만들기

이제 이벤트 허브 네임스페이스와 이벤트 허브가 있으므로 IoT Hub에서 이벤트 허브로 원격 분석 데이터를 전달해야 합니다.

#### 연습 5: 원격 분석 라우팅 추가

새로운 IoT Hub 라우팅이 준비되고 원격 분석 데이터가 이벤트 허브로 스트리밍되면 Stream Analytics 작업을 업데이트해야 합니다. 이 작업은 이벤트 허브의 데이터를 사용하고, **AnomalyDetection_SpikeAndDip** ML 모델을 사용하여 분석한 다음 그 결과를 Power BI로 출력해야 합니다.

#### 연습 6: Power BI 대시보드 만들기

이제 시나리오의 마지막 부분인 실제 데이터 시각화입니다. ML 모델을 통해 진동 원격 분석을 처리하고 결과를 Power BI로 출력하는 작업을 업데이트했습니다. 결과를 시각화하고 운영자의 의사 결정을 지원하기 위해 Power BI 내에서 여러 개의 타일이 있는 대시보드를 만들어야 합니다.

## LAB_AK_09

### 랩 시나리오

Contoso는 다양한 치즈 동굴의 온도를 모니터링할 수 있도록 새로 연결된 온도 조절기를 설치하고 있습니다. 새 온도 조절기가 설치되면 시설 관리자에게 알리는 경고를 만듭니다.

경고를 만들려면 IoT Hub에서 새 온도 조절기를 만들 때 디바이스에서 만든 이벤트 유형을 Event Grid로 푸시합니다. 이 이벤트(Event Grid에서)에 반응하는 Logic Apps 인스턴스를 가지게 되고, 시설 관리자 디바이스에 새 디바이스 생성, 디바이스 ID, 연결 상태를 알려주는 이메일을 전송합니다.

#### 연습 1: 랩 필수 구성 요소 확인

이 랩에서 다음 리소스를 사용할 수 있다고 가정합니다.

| 리소스 종류 | 리소스 이름 |
| :-- | :-- |
| 리소스 그룹 | AZ-220-RG |
| IoT Hub | AZ-220-HUB-_{YOUR-ID}_ |

리소스를 사용할 수 없는 경우 랩을 시작하기 전에 **lab-setup.azcli** 스크립트를 실행하세요.

#### 연습 2: 전자 메일을 보내는 HTTP 웹 후크 논리 앱 만들기

Azure Logic Apps는 기업 또는 조직 간에 애플리케이션, 데이터, 시스템 및 서비스를 통합해야 할 때 작업, 비즈니스 프로세스 및 작업 흐름을 자동화하고 오케스트레이션하는 데 도움이 되는 클라우드 서비스입니다.

이 연습에서는 HTTP 웹 후크를 통해 트리거되는 새 Azure 논리 앱을 만든 다음 Outlook.com 이메일 주소를 사용하여 이메일을 보냅니다.

#### 연습 3: Azure IoT Hub 이벤트 구독 구성

Azure IoT Hub는 Azure Event Grid와 통합되므로 다른 서비스에 이벤트 알림을 보내고 다운스트림 프로세스를 트리거할 수 있습니다. 비즈니스 애플리케이션을 구성하여 IoT Hub 이벤트를 수신 대기할 수 있으므로 중요한 이벤트에 안정적이고 확장 가능하며 안전한 방법으로 대응할 수 있습니다. 예를 들어, 데이터베이스를 업데이트하고, 작업 티켓을 만들고, 새 IoT 디바이스가 IoT Hub에 등록될 때마다 전자 메일 알림을 제공하는 애플리케이션을 빌드합니다.

이 연습에서는 Azure IoT Hub에서 이벤트 구독을 만들어 경고 전자 메일을 보내는 논리 앱을 트리거하는 이벤트 그리드 통합을 설정합니다.

## LAB_AK_10

### 랩 시나리오

Contoso의 자산 상태 추적을 통해 특정 자산의 온도가 급격히 상승했다는 것을 알아냈으며 근본 원인을 찾고자 합니다. 무슨 일이 일어났는지 알고 싶습니다. 운송 트럭과 비행기 센서에서 IoT 디바이스의 센서 데이터를 상호 연관시킵니다. 트럭 중 하나에서 온도가 상승하여 온도와 습도 센서가 있는 IoT 디바이스가 장착된 배송 상자 중 하나에서 열이 급상승했습니다. 팀은 거의 실시간으로 데이터를 살펴야 하고 근본 원인을 분석하여 제품이 최상의 상태로 유지되도록 납품 프로세스를 개선하는 데 도움을 줄 수 있어야 합니다.

Time Series Insights를 솔루션에 추가하여 트럭, 비행기 및 배송 상자 자체의 IoT 디바이스에서 생성되는 대량의 시계열 데이터를 신속하게 저장, 시각화 및 쿼리하여 시간에 따른 변화를 시각화할 수 있습니다.

#### 연습 1: 랩 필수 구성 요소 확인

이 랩에서 다음 리소스를 사용할 수 있다고 가정합니다.

| 리소스 종류 | 리소스 이름 |
| :-- | :-- |
| 리소스 그룹 | `AZ-220-RG` |
| IoT Hub | `AZ-220-HUB-{YOUR-ID}` |
| 디바이스 ID | `TruckDevice` |
| 디바이스 ID | `AirplaneDevice` |
| 디바이스 ID | `ContainerDevice` |

#### 연습 2: Time Series Insights 설정

Azure TSI(Time Series Insights)는 IoT(사물 인터넷) 솔루션에서 데이터를 규모에 맞게 수집, 처리, 저장, 분석 및 쿼리하는 데 사용되는 종단 간 PaaS(Platform as a service) 제품입니다. TSI는 매우 문맥화되고 시계열에 최적화된 데이터의 운영 분석 및 임시 데이터 탐색을 위해 설계되었습니다.

이 연습에서는 Azure IoT Hub와의 TSI(Time Series Insights) 통합을 설정합니다.

#### 연습 3: 시뮬레이션된 IoT 디바이스 실행

이 연습에서는 시뮬레이션된 디바이스를 실행하여 Azure IoT Hub로 원격 분석 이벤트를 보냅니다.

#### 연습 4: Time Series Insights 탐색기 보기

이 연습에서는 TSI(Time Series Insights) 탐색기를 사용하여 시계열 데이터로 작업하는 방법을 소개합니다.

## LAB_AK_11

### 랩 시나리오

Contoso는 전 세계적으로 치즈 생산 공장을 가지고 있습니다. 공장의 생산 라인에는 치즈를 만드는 여러 기계가 있습니다. 현재 센서 데이터를 Azure로 스트리밍하고 클라우드의 모든 데이터를 처리하는 각 기계에 IoT 디바이스가 연결되어 있습니다. 수집되는 데이터의 양이 많고 일부 컴퓨터에서는 응답 시간이 촉박하므로 Contoso는 중요한 데이터만 클라우드로 전송되도록 게이트웨이 디바이스를 추가하여 인텔리전스를 에지로 가져오려고 합니다. 또한 로컬 네트워크 상태가 나쁠 때에도 데이터를 처리하고 신속하게 대응할 수 있습니다.

컴퓨터 중 한 대의 온도를 모니터링할 수 있는 새로운 IoT Edge 디바이스를 설정하고 Stream Analytics 모듈을 배포하여 평균 온도를 계산하고 디바이스에 경고를 보내 신속하게 작동하도록 합니다.

#### 연습 1: 랩 필수 구성 요소 확인

[tbd]

#### 연습 2: Azure IoT Edge 사용 Linux VM 배포

이 연습에서는 Azure Marketplace에서 Azure IoT Edge 런타임 지원 Ubuntu Server VM을 배포합니다.

#### 연습 3: Azure CLI를 사용하여 IoT Hub에서 IoT Edge 디바이스 ID 만들기

이 연습에서는 Azure CLI를 사용하여 Azure IoT Hub에 새 IoT Edge 디바이스 ID를 만듭니다.

#### 연습 4: IoT Hub에 IoT Edge 디바이스 연결

이 연습에서는 IoT Edge 디바이스를 Azure IoT Hub에 연결합니다.

#### 연습 5: Edge 디바이스에 Edge 모듈 추가

이 연습에서는 시뮬레이션된 온도 센서를 사용자 지정 IoT Edge 모듈로 추가하고 이를 배포하여 IoT Edge 디바이스에서 실행합니다.

#### 연습 6: Azure Stream Analytics를 IoT Edge 모듈로 배포

이제 tempSensor 모듈이 IoT Edge 디바이스에서 배포되어 실행되고 있으므로 IoT Edge 디바이스에서 메시지를 처리할 수 있는 Stream Analytics 모듈을 추가하여 IoT Hub로 전송할 수 있습니다.

## LAB_AK_12

### 랩 시나리오

이 랩에서는 이론적이며 IoT Edge 디바이스를 게이트웨이로 사용할 수 있는 방법을 알려줍니다.

IoT Edge 디바이스를 게이트웨이로 사용하기 위한 세 가지 패턴은 투명, 프로토콜 번역 및 ID 번역입니다.

**투명** – 이론적으로 IoT Hub에 연결할 수 있는 디바이스는 게이트웨이 디바이스에 대신 연결할 수 있습니다. 다운스트림 디바이스에는 자체 IoT Hub ID가 있으며 MQTT, AMQP 또는 HTTP 프로토콜을 사용하고 있습니다. 게이트웨이는 단순히 디바이스와 IoT Hub 간 통신을 전달합니다. 디바이스는 게이트웨이를 통해 클라우드와 통신하고 있다는 것을 인식하지 못하며, IoT Hub의 디바이스와 상호 작용하는 사용자는 중간 게이트웨이 디바이스를 인식하지 못합니다. 따라서, 게이트웨이는 투명합니다. IoT Edge 디바이스를 투명 게이트웨이로 사용하는 방법에 대한 자세한 내용은 투명 게이트웨이 만들기를 참조하세요.

**프로토콜 번역** – 불투명 게이트웨이 패턴이라고도 하며 MQTT, AMQP 또는 HTTP를 지원하지 않는 디바이스는 이를 대신하여 게이트웨이 디바이스를 통해 데이터를 IoT Hub로 전송할 수 있습니다. 게이트웨이는 다운스트림 디바이스에서 사용하는 프로토콜을 이해하며, IoT Hub에 ID가 있는 유일한 디바이스입니다. 모든 정보는 하나의 디바이스인 게이트웨이에서 오는 것처럼 보입니다. 클라우드 애플리케이션이 디바이스별로 데이터를 분석하려는 경우 다운스트림 디바이스는 메시지에 추가 식별 정보를 포함해야 합니다. 또한, 쌍 및 메서드와 같은 IoT Hub 기본 형식은 다운스트림 디바이스가 아닌 게이트웨이 디바이스에서만 사용할 수 있습니다.

**ID 번역** - IoT Hub에 연결할 수 없는 디바이스는 게이트웨이 디바이스에 대신 연결할 수 있습니다. 게이트웨이는 다운스트림 디바이스는를 대신하여 IoT Hub ID 및 프로토콜 번역을 제공합니다. 게이트웨이는 다운스트림 디바이스에서 사용하는 프로토콜을 이해하고, ID를 제공하고, IoT Hub 기본 형식을 번역할 수 있을 만큼 똑똑합니다. 다운스트림 디바이스는 IoT Hub에 쌍과 메서드가 있는 최상위 디바이스로 표시됩니다. 사용자는 IoT Hub의 디바이스와 상호 작용할 수 있으며 중간 게이트웨이 디바이스를 인식하지 못합니다.

#### 연습 1: 랩 필수 구성 요소 확인

[tbd]

#### 연습 2: Azure IoT Edge 사용 Linux VM 배포

이 연습에서는 Azure Marketplace에서 Azure IoT Edge 런타임 지원 Ubuntu Server VM을 배포합니다.

#### 연습 3: IoT Edge 디바이스 CA 인증서 생성 및 구성

이 연습에서는 Linux를 사용하여 테스트 인증서를 생성합니다. `Azure/IoTEdge` GitHub 프로젝트에 포함된 도우미 스크립트를 사용하여 `AZ-220-VM-EDGEGW-{YOUR-ID}` 가상 머신에서 이 작업을 수행합니다.

#### 연습 4: Azure Portal을 사용하여 IoT Hub에서 IoT Edge 디바이스 ID 만들기

이 연습에서는 IoT Edge 투명 게이트웨이용 Azure IoT Hub에서 새 IoT Edge 디바이스 ID를 만듭니다.

#### 연습 5: IoT Edge 게이트웨이 호스트 이름 설정

이 연습에서는 **AZ-220-VM-EDGEGW-_{YOUR-ID}_**의 공용 IP 주소에 대한 DNS 이름을 지정하고 해당 DNS 이름을 IoT Edge 게이트웨이 디바이스의 `hostname`으로 구성합니다.

#### 연습 6: IoT Edge 게이트웨이 디바이스를 IoT Hub에 연결

이 연습에서는 IoT Edge 디바이스를 Azure IoT Hub에 연결합니다.

#### 연습 7: 통신용 IoT Edge 게이트웨이 디바이스 포트 열기

이 연습에서는 인터넷에서 Azure IoT Edge 게이트웨이 액세스를 보호하는 NSG(네트워크 보안 그룹)를 구성합니다. 다운스트림 IoT 디바이스가 게이트웨이와 통신할 수 있도록 MQTT, AMQP 및 HTTPS 통신에 필요한 포트를 열어야 합니다.

Azure IoT Edge 게이트웨이가 작동하려면 다운스트림 디바이스에서 인바운드 트래픽에 대해 IoT Edge 허브에서 지원되는 프로토콜 중 하나 이상을 열어야 합니다. 지원되는 프로토콜은 MQTT, AMQP 및 HTTPS입니다.

Azure IoT Edge에서 지원하는 IoT 통신 프로토콜에는 다음과 같은 포트 매핑이 있습니다.

| 프로토콜 | 포트 번호 |
| --- | --- |
| MQTT | 8883 |
| AMQP | 5671 |
| HTTPS<br/>MQTT + WS (Websocket)<br/>AMQP + WS (Websocket) | 443 |

디바이스에 선택한 IoT 통신 프로토콜은 IoT Edge 게이트웨이 디바이스를 보호하는 방화벽에 대해 해당 포트를 열어야 합니다. 이 랩의 경우 Azure NSG(네트워크 보안 그룹)이 IoT Edge 게이트웨이를 보호하는 데 사용되므로 이러한 포트에서 NSG에 대한 인바운드 보안 규칙이 열립니다.

프로덕션 시나리오에서는 디바이스가 통신할 수 있는 최소 포트 수만 열려고 합니다. MQTT를 사용하는 경우 인바운드 통신에 대해서만 포트 8883을 엽니다. 추가 포트를 열면 공격자가 악용할 수 있는 추가 보안 공격 벡터가 생깁니다. 솔루션에 필요한 최소 포트 수만 여는 것이 보안 모범 사례입니다.

#### 연습 8: IoT Hub에서 다운스트림 디바이스 ID 만들기

이 연습에서는 다운스트림 IoT 디바이스용 Azure IoT Hub에서 새 IoT 디바이스 ID를 만듭니다. 이 디바이스 ID는 Azure IoT Edge 게이트웨이가 이 다운스트림 디바이스의 상위 디바이스가 되도록 구성됩니다.

#### 연습 9: 다운스트림 디바이스를 IoT Edge 게이트웨이에 연결

이 연습에서는 IoT Edge 게이트웨이에 연결하도록 미리 빌드된 다운스트림 디바이스를 구성합니다.

#### 연습 10: 이벤트 흐름 확인

이 연습에서는 Azure CLI를 사용하여 IoT Edge 게이트웨이를 통해 다운스트림 IoT 디바이스에서 Azure IoT Hub로 전송되는 이벤트를 모니터링합니다. 이렇게 하면 모든 것이 올바르게 작동하는지 확인합니다.

## LAB_AK_13

### 랩 시나리오

Contoso의 웨어하우스에서는 컨베이어 벨트에 배송 준비가 완료된 재고를 이동시킵니다.

정확한 물량의 제품이 포장되었는지 확인하기 위해 동일한 IoT Edge 디바이스에서 다른 개체 감지 모듈(시뮬레이션)로 벨트에서 감지된 개체를 계수하는 간단한 모듈을 추가합니다. 개체를 계수하는 사용자 지정 모듈을 만드는 방법을 보여 드리겠습니다.

이 랩에는 개발 컴퓨터(랩 호스트 환경 - VM 또는 PC)에 대한 다음과 같은 전제 조건이 있습니다.

* 다음의 확장 프로그램이 설치된 Visual Studio Code:
  * Microsoft의 [Azure IoT Tools](https://marketplace.visualstudio.com/items?itemName=vsciot-vscode.azure-iot-tools)
  * Microsoft [C#](https://marketplace.visualstudio.com/items?itemName=ms-vscode.csharp)
  * [Docker](https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-docker)
* Docker Client 버전 18.03.0 이상으로 개발 컴퓨터에 설치된 Docker Community Edition
  * [Mac 및 Windows용 Docker 데스크톱 다운로드](https://www.docker.com/products/docker-desktop)

    > **중요**: 2020년 1월 13일 TLS 버전 1.2 이전에 TLS에 대한 Azure Container Registry 지원이 제거되었기 때문에 Docker 클라이언트 18.03.0 이상을 사용해야 합니다.

#### 연습 1: 랩 필수 구성 요소 확인

[tbd]

#### 연습 2: Azure IoT EdgeHub 개발 도구 설치

이 연습에서는 Azure IoT EdgeHub 개발 도구를 설치합니다.

#### 연습 3: Azure Container Registry 만들기

Azure Container Registry는 컨테이너 배포를 위해 비공개 Docker 이미지 스토리지를 제공합니다. 서비스는 오픈 소스 Docker Registry 2.0을 기반으로 하는 관리형 비공개 Docker 레지스트리 서비스입니다. Azure Container Registry는 비공개 Docker 컨테이너 이미지를 저장하고 관리하는 데 사용됩니다.

이 연습에서는 Azure Portal을 사용하여 새 Azure Container Registry 리소스를 만듭니다.

#### 연습 4: C\#으로 사용자 지정 Edge 모듈 만들기

이 연습에서는 C#으로 작성된 사용자 지정 Azure IoT Edge 모듈이 포함된 Azure IoT Edge 솔루션을 만듭니다.

#### 연습 5: IoT Edge 시뮬레이터를 통해 연결 모드에서 디버그

이 연습에서는 Visual Studio Code에서 IoT Edge 시뮬레이터를 사용하여 사용자 지정 IoT Edge 모듈 솔루션을 빌드하고 실행합니다.

#### 연습 6: IoT Edge 솔루션 배포

이 연습에서는 사용자 지정 IoT Edge 모듈을 빌드하고 ACR(Azure Container Registry) 서비스에 게시합니다. ACR에 게시되면 사용자 지정 모듈을 모든 IoT Edge 디바이스에 배포할 수 있습니다.

## LAB_AK_14

### 랩 시나리오

컨베이어 벨트 시스템은 진동, 원격 분석 및 개체를 계수합니다. 시스템이 네트워크 중단에 탄력적이고 하루 중 특정 시간에 원격 분석 데이터의 대량 업로드를 최적화하려고 합니다(네트워크 사용량 부하 분산). 네트워크가 중단되면 오프라인으로 지원하도록 IoT Edge를 구성하고, 센서의 원격 분석을 로컬에 저장하고 지정된 시간에 정기적인 동기화를 구성할 계획입니다.

IoT Edge 디바이스가 엔터프라이즈 네트워크에 있거나(프록시 설정이 필요) 확장된 오프라인 기능이 필요한 다양한 시나리오를 배웁니다.

#### 연습 1: 랩 필수 구성 요소 확인

이 랩에서 다음 리소스를 사용할 수 있다고 가정합니다.

| 리소스 종류 | 리소스 이름 |
| :-- | :-- |
| 리소스 그룹 | AZ-220-RG |
| IoT Hub | AZ-220-HUB-_{YOUR-ID}_ |
| IoT 디바이스 | SimulatedThermostat |

#### 연습 2: Azure IoT Edge 사용 Linux VM 배포

이 단원에서는 Azure Marketplace에서 Azure IoT Edge 런타임을 지원하는 Ubuntu Server VM을 배포합니다. 이전 랩에서는 Azure Portal을 사용하여 VM을 만들었습니다. 이번에는 Azure CLI를 사용하여 VM을 만듭니다.

#### 연습 3: 자식 IoT 디바이스로 IoT Edge 부모 설정

이 연습에서는 IoT Edge 디바이스와 자식 관계인 IoT 디바이스를 Azure IoT Hub에 등록합니다. 이렇게 하면 클라우드의 Azure IoT Hub와 통신하기 전에 자식 IoT 디바이스가 게이트웨이가 되어 IoT Edge 디바이스를 통해 메시지를 전송할 수 있습니다.

IoT Edge 게이트웨이(부모) 및 기타 IoT 디바이스(자식 또는 리프 디바이스)를 포함한 부모/자식 관계를 이용하면 Azure IoT 솔루션에서 오프라인 기능을 사용할 수 있습니다.

다음 다이어그램은 Azure IoT Edge 디바이스(부모)와 하위 디바이스 간의 관계를 보여줍니다.

![자식 디바이스가 있는 IoT Edge 부모 다이어그램](images/IoTEdge-Parent-Child-Relationship.jpg "IoT Edge Parent with Child Device Diagram")

이 시나리오에서는 자식 디바이스가 Azure IoT Hub 자격 증명을 사용하여 부모 IoT Edge 디바이스에 연결하고 인증합니다. 인증이 되면 자식 IoT 디바이스는 IoT Edge 디바이스의 Edge 허브(`$edgeHub`)로 메시지를 보냅니다. 메시지가 부모 IoT Edge 디바이스에 도달하면 IoT Edge 모듈과 라우팅은 구성된 대로 메시지를 처리합니다(연결할 때 Azure IoT Hub로 메시지를 보내는 것 포함).

부모 IoT Edge 디바이스의 연결이 끊어지거나 Azure IoT Hub에 연결되지 않을 경우 모든 디바이스 메시지가 IoT Edge 디바이스에 자동으로 저장됩니다. 연결이 복원되면 IoT Edge 디바이스는 다시 연결하고 저장된 메시지를 Azure IoT Hub로 보냅니다. IoT Edge 디바이스에 저장된 메시지는 디바이스의 TTL(Time-to-Live) 구성에 따라 만료될 수 있습니다(기본적으로 메시지를 최대 `7200`초(2시간)까지 저장하도록 설정되어 있음).

#### 연습 4: IoT Edge 디바이스를 게이트웨이로 구성

이 연습에서는 이전에 생성된 Ubuntu 가상 머신에서 Azure IoT Edge를 IoT Edge 투명 게이트웨이 디바이스로 구성합니다. 구성은 프로세스를 더 빠르게 만들기 위해 이 디바이스의 일부인 도우미 스크립트에 의해 처리됩니다.

#### 연습 5: Azure CLI를 사용하여 IoT Edge 게이트웨이 디바이스 인바운드 포트 열기

이 연습에서는 Azure CLI를 사용하여 인터넷에서 Azure IoT Edge 게이트웨이에 대한 액세스를 보호하는 NSG(네트워크 보안 그룹)를 구성합니다. 다운스트림 IoT 디바이스가 게이트웨이와 통신할 수 있도록 MQTT, AMQP 및 HTTPS 통신에 필요한 포트를 열어야 합니다.

Azure IoT Edge 게이트웨이가 자식 IoT 디바이스와 통신하려면 **인바운드** 통신에 대해 디바이스 프로토콜용 TCP/IP 포트가 열려 있어야 합니다. 이 디바이스는 지원되는 세 가지 프로토콜 중 하나를 사용하여 IoT 게이트웨이와 통신할 수 있습니다.

지원되는 프로토콜에 대한 TCP/IP 포트 번호는 다음과 같습니다.

| 프로토콜 | 포트 번호 |
| --- | --- |
| MQTT | 8883 |
| AMQP | 5671 |
| HTTPS<br/>MQTT + WS (Websocket)<br/>AMQP + WS (Websocket) | 443 |

#### 연습 6: IoT Edge 디바이스 TTL(Time to Live) 및 메시지 저장소 구성

이 연습에서는 Azure IoT Edge 게이트웨이 디바이스에서 Edge Hub 모듈의 TTL(Time-to-Live) 메시지를 기본값보다 길게 구성합니다. 메시지를 저장할 IoT Edge 디바이스의 저장소 위치도 구성합니다.

기본값인 `7200`(2시간)은 오랜 시간 동안 오프라인 모드에서 작동해야 하는 디바이스나 솔루션에는 충분하지 않습니다. 디바이스와 솔루션이 연결이 끊긴 상태에서 장시간 작동하도록 하려면 IoT Edge 허브 모듈의 TTL(Time-to-Live) 속성을 2주 TTL 기간(1,209,600초)으로 설정합니다.

IoT Edge Hub용 모듈 쌍을 `$edgeHub`라고 하며 디바이스에서 실행되는 IoT Edge Hub와 Azure IoT Hub 서비스 간 통신을 조정하는 데 사용됩니다. 모듈 쌍에 대한 필요한 속성에서 `storeAndForwardConfiguration.timeToLiveSecs` 속성은 Azure IoT Hub와 같은 라우팅 엔드포인트에서 연결이 끊어진 상태로 IoT Edge 허브가 메시지를 유지하는 시간을 초 단위로 지정합니다.

Edge 허브에 대한 `timeToLiveSecs` 속성은 단일 디바이스 또는 대규모 배포의 일부로 특정 디바이스의 배포 매니페스트에 지정할 수 있습니다. 이 단원에서는 Azure IoT Hub용 Azure Portal 사용자 인터페이스를 사용하여 단일 IoT Edge 게이트웨이 디바이스에서 Edge 허브(`$edgeHub`) 모듈의 `timeToLiveSecs` 속성을 수정합니다.

#### 연습 7: 자식 IoT 디바이스를 IoT Edge 게이트웨이에 연결

이 연습에서는 구성된 대칭 키를 사용하여 IoT Hub에 연결하도록 다운스트림 자식 IoT 디바이스를 구성합니다. 디바이스는 부모 IoT Edge 디바이스의 게이트웨이 호스트 이름 외에도 대칭 키가 포함된 연결 문자열을 사용하여 IoT Hub 및 부모 IoT Edge 디바이스에 연결하도록 구성됩니다.

대칭 키를 사용하여 일반 IoT 디바이스를 IoT Hub에 인증하는 프로세스는 다운스트림(또는 자식/리프) 디바이스에도 적용됩니다. 유일한 차이점은 연결을 라우팅하기 위해 게이트웨이 디바이스에 포인터를 추가하거나 오프라인 시나리오에서 IoT Hub를 대신하여 인증을 처리해야 한다는 것입니다.

이전 단원에서는 Azure IoT Hub에서 IoT 디바이스 ID를 만들었습니다. IoT 디바이스의 **연결 문자열**을 복사했습니다. 또는, Azure IoT Hub에서 디바이스의 디바이스 ID를 위해 Azure Portal에서 연결 문자열에 액세스할 수 있습니다.

#### 연습 8: 디바이스 연결 및 오프라인 지원 테스트

이 연습에서는 **IoTEdgeGateway** IoT Edge 투명 게이트웨이를 통해 Azure IoT Hub로 전송되는 **ChildIoTDevice**에서 이벤트를 모니터링합니다. 그런 다음, **IoTEdgeGateway**와 Azure IoT Hub 간 연결을 중단하여 원격 분석이 자식 IoT 디바이스에서 IoT Edge 게이트웨이로 계속 전송되는지 확인합니다. 그런 다음, Azure IoT Hub에 다시 연결하고 IoT Edge 게이트웨이가 Azure IoT Hub로 원격 분석을 다시 전송하는지 모니터링합니다.

## LAB_AK_15

### 랩 시나리오

남부에 위치한 치즈 제조 회사를 관리한다고 가정하겠습니다. 이 회사는 치즈를 자랑스럽게 생각하며 치즈를 숙성하는 데 사용되는 천연 동굴의 완벽한 온도와 습도를 유지하기 위해 노력하고 있습니다. 동굴에는 온도와 습도를 알려주는 센서가 있습니다. 원격 운영자는 숙성 치즈를 위해 완벽한 환경을 유지하는 데 필요하다면 팬을 새로 설정할 수 있습니다. 팬은 냉난방, 가습 및 제습이 가능합니다.

동굴은 치즈를 숙성하는 데 이용되며, 일정한 온도, 습도 및 공기 흐름으로 인해 숙성에 안성맞춤입니다. 치즈 제품이 인위적인 창고 대신에 천연 동굴에서 숙성되는 것은 말할 것도 없습니다. 제품 라벨에 표기할 수 있습니다!

숙성 치즈의 이상적인 온도는 섭씨 10도(화씨 50도)이며, 최대 +/- 2.78도(화씨 5도)가 허용됩니다. 습도도 중요합니다. 최대 포화도의 백분율로 측정하면 75~95%의 습도가 좋습니다. 85%를 이상적인 값으로 설정하고 10%의 변동을 허용하도록 설정합니다. 이러한 값은 대부분의 치즈에 적용됩니다. 치즈 제조업체는 특정한 껍질 상태와 같은 특정한 결과를 얻기 위해 숙성 시 일정 시간 동안 이러한 값을 조정합니다.

남부에 있는 지표면 근처의 자연 동굴은 주변 온도가 약 70도일 수 있습니다. 동굴은 지붕을 통해 물이 스며들기 때문에 상대 습도도 100%에 가깝습니다. 이러한 높은 수치는 숙성 치즈에 완벽한 조건이 아닙니다. 북쪽에 위치한 자연 동굴의 주변 온도는 50도가 이상적입니다. 위치 때문에 Azure IoT가 개입해야 합니다!

#### 원격 분석 전송 및 수신

원격 분석 출력의 빈도는 중요한 요소입니다. 냉장 장치의 온도 센서는 1분마다 또는 그 이하에서 보고해야 할 수 있습니다. 항공기의 가속 센서는 적어도 1초마다 보고해야 할 수 있습니다.

IoT 디바이스에는 하나 이상의 센서와 일부 계산 능력이 탑재되어 있습니다. IoT 디바이스에는 LED 조명(작은 화면도)이 있습니다. 그러나, 디바이스는 운영자가 직접 사용하는 것이 아닙니다. IoT 디바이스는 클라우드에서 지시를 받도록 설계되었습니다.

#### 치즈 동굴 디바이스 제어

이 모듈에서는 IoT 치즈 동굴 모니터링 디바이스에 온도와 습도 센서가 있다고 가정합니다. 이 디바이스에는 난방 또는 냉방, 가습 또는 제습이 가능한 팬이 있습니다. 이 디바이스는 몇 초마다 현재 온도와 습도 값을 IoT Hub로 전송합니다. 이렇게 잦은 횟수는 빠른 조치가 필요한 코드 개발 단계를 제외하고 치즈 동굴에는 비현실적입니다(15분 또는 그 이하가 적절).

이 랩에서는 팬에 켜기, 끄기 및 고장인 세 가지의 상태가 있다고 가정합니다. 팬이 꺼져 있는 상태로 초기화됩니다. 이후 단원에서는 직접 메서드를 사용하여 팬이 켜집니다.

IoT 디바이스의 또 다른 특징은 IoT Hub에서 원하는 값을 수용할 수 있다는 것입니다. 그런 다음, 디바이스는 팬을 이 값으로 조정할 수 있습니다. 이 값은 디바이스 쌍이라는 기능을 사용하여 이 모듈에서 코딩됩니다. 원하는 값은 디바이스의 기본 설정을 재정의합니다.

#### 샘플 코딩

이 모듈의 코딩은 세 부분(원격 분석 송수신, 직접 메서드 송수신, 디바이스 쌍 관리)으로 나누어져 있습니다.

먼저 두 개의 앱을 작성하겠습니다. 하나는 디바이스에서 원격 분석을 보내는 용이고 다른 하나는 원격 분석을 수신하기 위해 클라우드에서 실행되는 백 엔드 서비스용입니다. 기본 언어(Node.js 또는 C#)와 개발 환경(Visual Studio Code 또는 Visual Studio)을 선택할 수 있습니다.

#### 연습 1: IoT Hub 포털을 사용하여 사용자 지정 Azure IoT Hub 만들기

이 랩에서 다음 리소스를 사용할 수 있다고 가정합니다.

| 리소스 종류 | 리소스 이름 |
| :-- | :-- |
| 리소스 그룹 | AZ-220-RG |
| IoT Hub | AZ-220-HUB-_{YOUR-ID}_ |
| IoT 디바이스 | CheeseCaveID |

#### 연습 2: 원격 분석을 보내고 받을 코드 작성

이 단원의 끝에서 원격 분석을 보내고 받습니다.

#### 연습 2: 원격 분석을 받을 두 번째 앱 만들기

이제 원격 분석을 전송하는 디바이스가 있으며, IoT Hub에 연결된 백 엔드 앱으로 해당 원격 분석을 수신해야 합니다.

#### 연습 3: 직접 메서드를 호출하는 코드 작성

이 단원에서는 직접 메서드가 팬을 켤 수 있도록 코드를 디바이스 앱에 추가합니다. 다음으로, 백 엔드 서비스 앱에 코드를 추가하여 이 직접 메서드를 호출합니다.

직접 메서드를 호출하는 백 엔드 앱의 호출에는 페이로드의 일부로 여러 매개 변수가 포함될 수 있습니다. 직접 메서드는 일반적으로 디바이스의 기능을 끄고 켜거나 디바이스에 대한 설정을 지정하는 데 사용됩니다.

#### 연습 4: 디바이스 쌍에 대한 코드 작성

이 연습에서는 디바이스 앱과 백 엔드 서비스 앱 모두에 일부 코드를 추가하여 디바이스 쌍 동기화가 작업 중인 것을 보여줍니다.

디바이스 쌍에는 다음 네 가지 유형의 정보가 포함되어 있습니다.

* **태그**: 디바이스에 표시되지 않는 디바이스의 정보입니다.
* **원하는 속성**: 백 엔드 앱에서 지정한 원하는 설정입니다.
* **보고된 속성**: 보고된 디바이스의 설정 값입니다.
* **디바이스 ID 속성**: 디바이스를 식별하는 읽기 전용 정보입니다.

디바이스 쌍은 실제 IoT Hub 디바이스와 쿼리하고 자동으로 동기화하도록 설계되었습니다. 디바이스 쌍은 백 엔드 앱에서 언제든지 쿼리할 수 있습니다. 이 쿼리는 디바이스에 대한 현재 상태 정보를 반환할 수 있습니다. 디바이스와 쌍이 자동으로 동기화되기 때문에 이 데이터를 가져오는 것에는 디바이스 호출이 수반되지 않습니다. 디바이스 쌍의 주요 기능들은 Azure IoT에서 제공되므로 이를 사용하기 위해 많은 코드를 작성할 필요가 없습니다.

디바이스 쌍과 직접 메서드의 기능 사이에는 약간의 중복이 있습니다. 직관적인 방식으로 보일 수 있는 직접 메서드를 사용하여 원하는 속성을 설정할 수 있습니다. 그러나 직접 메서드를 사용하려면 백 엔드 앱에 액세스해야 할 경우 해당 설정을 명시적으로 기록해야 합니다. 디바이스 쌍을 사용하면 이 정보는 기본적으로 저장되고 유지됩니다.

## LAB_AK_16

### 랩 시나리오

치즈 동굴의 온도와 습도를 최적으로 유지하고 모니터링할 수 있는 솔루션을 제공하는 회사를 관리한다고 가정합니다. 치즈 생산 회사들에서 장기간 근무했으며, 제품의 품질을 소중히 여기는 이러한 고객들과 오랜 신뢰 관계를 구축했습니다.

솔루션은 온도와 습도를 실시간으로 보고하는 동굴 센서와 온도 시스템으로 구성되어 있으며, 온라인 포털 고객은 동굴에 저장된 치즈의 종류에 따라 온도와 습도를 조정하거나 치즈를 완벽하게 숙성시키기 위해 환경을 미세 조정하는 디바이스를 모니터링하고 원격으로 조정할 수 있습니다.

회사는 고객이 다양한 치즈와 치즈를 저장하는 데 사용하는 다양한 유형의 방에 더 잘 적응할 수 있도록 디바이스에서 실행되는 소프트웨어를 항상 개선하고 있습니다. 기능 업데이트 외에도 고객 위치에 배포된 디바이스에 개인 정보를 보호하고 해커가 시스템을 제어하지 못하도록 하는 최신 보안 패치가 설치되어 있는지 확인해야 합니다. 이렇게 하려면 펌웨어를 원격으로 업데이트하여 디바이스를 최신 상태로 유지해야 합니다.

#### 연습 1: Azure IoT Hub 및 디바이스 ID 만들기

이 랩에서 다음 리소스를 사용할 수 있다고 가정합니다.

| 리소스 종류 | 리소스 이름 |
| :-- | :-- |
| 리소스 그룹 | AZ-220-RG |
| IoT Hub | AZ-220-HUB-_{YOUR-ID}_ |
| IoT 디바이스 | SimulatedSolutionThermostat |

#### 연습 2: 펌웨어 업데이트를 구현하는 디바이스를 시뮬레이션하는 코드 작성

이 작업이 끝나면 IoT Hub의 펌웨어 업데이트 요청을 기다리는 디바이스 시뮬레이터가 있습니다.

IoT 디바이스에서 첫 번째 펌웨어 업데이트를 시작하기 전에 잠시 시간을 내어 이러한 작업이 실제로 무엇을 의미하는지, Azure IoT Hub가 프로세스를 만드는 데 어떤 도움이 되는지 확인하세요.
##### IoT 디바이스의 펌웨어 업데이트는 무엇을 의미합니까?

IoT 디바이스는 대부분 최적화된 운영 체제에 의해 구동되거나 때로는 실제 운영 체제없이 실리콘에서 직접 코드를 실행합니다. 이러한 종류의 디바이스에서 실행되는 소프트웨어를 업데이트하기 위한 가장 일반적인 방법은 OS와 실행 중인 앱(펌웨어라고 함)을 포함하여 전체 소프트웨어 패키지의 새 버전을 플래시하는 것입니다.

각 디바이스에는 특정 목적이 있으므로 펌웨어도 디바이스의 목적뿐만 아니라 사용 가능한 제한된 리소스에 맞게 매우 구체적이고 최적화되어 있습니다.

또한 펌웨어를 업데이트하는 작업은 하드웨어 자체와 하드웨어 제조업체의 방식에 따라 매우 다를 수 있습니다. 이는 펌웨어 업데이트 프로세스의 일부가 일반적이지 않으며 펌웨어 업데이트 프로세스의 세부 정보를 얻으려면 디바이스 제조업체와 협력해야 함을 의미합니다(단, 자체 하드웨어를 개발하는 경우, 즉 펌웨어 업데이트 프로세스를 알고 있는 경우는 예외).

펌웨어 업데이트는 디바이스에 수동으로 적용할 수 있지만, IoT 솔루션의 규모가 급격히 증가하는 점을 고려하면 이 방식은 더 이상 가능하지 않습니다. 클라우드에서 원격으로 관리하는 새 펌웨어가 배포되면서 현재 펌웨어 업데이트는 OTA(Over-the-Air)에서 이루어지는 경우가 훨씬 많아졌습니다.

IoT 디바이스에 대한 모든 OTA 펌웨어 업데이트에는 다음과 같은 공통점이 있습니다.

1. 펌웨어 버전은 고유하게 식별됩니다.
1. 펌웨어는 디바이스가 온라인 소스에서 가져와야 할 이진 파일 형식으로 제공됩니다.
1. 펌웨어는 로컬로 저장되며 이는 일종의 실제 저장소(ROM 메모리, 하드 드라이브 등)입니다.
1. 디바이스 제조업체는 펌웨어를 업데이트하기 위해 디바이스에서 필요한 작업에 대한 설명을 제공합니다.

##### Azure IoT Hub 자동 디바이스 관리

Azure IoT Hub는 하나의 디바이스 및 디바이스 컬렉션에서 디바이스를 관리할 수 있도록 고급 지원을 제공합니다. [자동 디바이스 관리](https://docs.microsoft.com/azure/iot-hub/iot-hub-auto-device-config) 기능을 사용하면 작업 집합을 간단히 구성하고, 이를 트리거한 다음, 실행을 모니터링할 수 있습니다.

이 연습에서는 원하는 디바이스 쌍의 속성 변경 내용을 관리하고 펌웨어 업데이트를 시뮬레이션하는 로컬 프로세스를 트리거할 간단한 시뮬레이터를 만듭니다. 전체 프로세스는 실제 디바이스의 경우에도 동일합니다(로컬 펌웨어 업데이트에 대한 실제 단계 제외). 그런 다음 Azure Portal을 사용하여 단일 디바이스에 대한 펌웨어 업데이트를 구성하고 실행합니다. IoT Hub는 디바이스 쌍 속성을 사용하여 구성 변경 요청을 디바이스로 전송하고 진행 상황을 모니터링합니다.

#### 연습 3: 단일 디바이스에서 펌웨어 업데이트 테스트

이 연습에서는 Azure Portal을 사용하여 새 디바이스 관리 구성을 만들고 이를 하나의 시뮬레이션된 디바이스에 적용합니다.

## LAB_AK_17

### 랩 시나리오

자산 추적 솔루션이 점점 커지기 때문에 하나씩(DPS를 통하더라도) 디바이스를 프로비저닝하는 것을 조정할 수 없습니다. DPS를 사용하여 x.509 인증서 인증을 통해 여러 디바이스를 자동으로 안전하게 등록하려고 합니다. 솔루션 내에서 센서를 사용하여 운송 중인 자산을 추적합니다. 센서가 배송 상자에 부착될 때마다 DPS를 통해 센서가 자동으로 프로비저닝됩니다. 창고 관리자를 위해 "태그가 부착된" 상자 수에 대한 메트릭을 구성하고, IoT Hub에서 디바이스가 연결된 이벤트를 계산해야 합니다.

이 랩에서는 루트 CA x.509 인증서 체인을 사용하여 DPS(디바이스 프로비저닝 서비스) 내에 그룹 등록을 설정합니다. 모니터링을 사용하여 연결된 디바이스 및 원격 분석 메시지 전송 개수를 추적하고 로그에 연결 이벤트를 보내도록 연결된 IoT Hub를 구성합니다. 또한 연결된 디바이스의 평균 수에 따라 트리거되는 경고를 만듭니다. 루트 CA 인증서 체인에서 생성된 디바이스 CA 인증서를 사용하여 DPS로 인증하는 10개의 시뮬레이션된 IoT 디바이스를 구성합니다. IoT 디바이스는 원격 분석을 IoT Hub로 보내도록 구성됩니다.

#### 연습 1: 랩 필수 구성 요소 확인

[tbd]

#### 연습 2: IoT Hub를 사용하여 메트릭 및 진단 로그 설정 및 사용

프로덕션 환경에서 실행 중인 IoT Hub 솔루션이 있는 경우 일부 메트릭을 설정하고 진단 로그를 사용하도록 설정하려고 합니다. 그런 다음, 문제가 발생하면 문제를 진단하고 더 빨리 해결하는 데 도움이 되는 데이터를 확인할 수 있습니다. 이 랩에서는 진단 로그를 사용하도록 설정하는 방법과 오류를 확인하는 방법을 살펴보겠습니다. 확인할 몇 가지 메트릭, 그리고 메트릭이 특정 경계에 도달하면 발생하는 경고도 설정합니다.

예를 들어, 연결된 디바이스 수가 특정 임계값을 초과하거나 사용된 메시지 수가 IoT Hub에 허용되는 일일 메시지 할당량에 가까워지면 이메일을 보낼 수 있습니다.

#### 연습 3: 로깅 사용

Azure Resource 로그는 내부 작업을 설명하는 Azure 리소스에서 내보내는 플랫폼 로그입니다. 모든 리소스 로그는 공통된 최상위 스키마를 공유하며, 각 서비스가 자체 이벤트에 대해 고유한 속성을 전송할 수 있는 유연성이 있습니다.

#### 연습 4: 경고 구성

이제 경고를 만들어 보겠습니다. 경고는 모니터링 데이터에서 중요한 조건이 발견되면 사전에 알려줍니다. 이를 통해 시스템 사용자가 문제를 인지하기 전에 문제를 식별하고 해결할 수 있습니다. 자산 추적 시나리오에서는 센서를 사용하여 전송 중인 자산을 추적합니다. 센서가 배송 상자에 부착될 때마다 DPS를 통해 센서가 자동으로 프로비저닝됩니다. 창고 관리자를 위해 "태그가 부착된" 상자 수에 대한 메트릭을 구성하고, IoT Hub에서 디바이스가 연결된 이벤트를 계산해야 합니다.

이 작업에서는 5개 이상의 디바이스가 연결되었을 때 창고 관리자에게 알리는 경고를 추가합니다.

#### 연습 5: 센서 시뮬레이션

자산 추적 시나리오의 일부로 운송 중에 자산을 추적하는 데 사용할 태그를 시뮬레이션하는 디바이스가 있어야 합니다. 각 디바이스가 활성화되면 자동 디바이스 프로비저닝을 사용하여 IoT 솔루션에 연결하고 원격 분석 전송을 시작해야 합니다. 자동으로 연결하려면 각 디바이스에 그룹 등록을 만드는 데 사용되는 루트 인증서 체인의 일부인 자체 X509 인증서가 필요합니다.

이 작업에서는 기존 환경을 확인하고, 필요한 설정을 구성하고, 10개의 디바이스 인증서를 생성하고, 10개의 디바이스를 시뮬레이션하는 콘솔 애플리케이션을 구성합니다.

#### 연습 6: 디바이스 시뮬레이션

이 작업에서는 루트 인증서에서 X509 인증서를 생성합니다. 그런 다음, 콘솔 애플리케이션에서 이 인증서를 사용하여 DPS에 연결하고, 원격 분석을 IoT Hub로 보내는 10개의 디바이스를 시뮬레이션합니다.

#### 연습 7: 메트릭, 경고 및 보관 검토

[TBD]

## LAB_AK_18

**MISING**

## LAB_AK_19

### 랩 시나리오

Contoso는 보안을 염두에 두고 모든 솔루션을 구축했습니다. 그러나, Azure IoT 솔루션을 포함하여 모든 온-프레미스 및 클라우드 워크로드에서 보안을 더욱 자세히 확인할 수 있는 방법을 알아보려고 합니다. 또한, 새 디바이스를 추가할 때 워크로드(리프 디바이스, Microsoft Edge 디바이스, IoT Hub)에 보안 정책을 적용하여 보안 표준을 준수하고 보안 상태를 개선하려고 합니다.

Contoso는 신규 주문으로 인해 증가하는 배송과 포장 수요를 지원하는 새로운 IoT 디바이스를 갖춘 새로운 어셈블리 라인을 추가하고 있습니다. 새로운 디바이스가 보호되고 전체 종단 간 IoT 솔루션에서 솔루션 보안을 지속적으로 개선하기 위해 보안 권장 사항을 확인하려고 합니다. 솔루션에 대한 IoT용 Azure IoT 센터를 사용하여 조사를 시작합니다.

#### 연습 1: 랩 필수 구성 요소 확인

[tbd]

#### 연습 2: Azure Portal을 사용하여 IoT Hub 만들기

이 작업에서는 Azure Portal을 사용하여 IoT Hub 리소스를 만듭니다.

#### 연습 3: IoT Hub용 Azure Security Center 활성화

IoT Hub용 Azure Security Center는 보안 관리를 통합하고, 하이브리드 클라우드 워크로드 및 Azure IoT 솔루션 전반에서 종단 간 위협 탐지와 분석을 가능하게 해줍니다.

#### 연습 4: 새 디바이스 만들기 및 등록

[TBD]

#### 연습 5: 보안 모듈 쌍 만들기

IoT용 Azure Security Center는 기존 IoT 디바이스 관리 플랫폼과 완전히 통합되어 디바이스 보안 상태를 관리하고 기존의 디바이스 제어 기능을 활용할 수 있도록 해줍니다. IoT용 Azure Security Center 통합은 IoT Hub 쌍 메커니즘으로 가능합니다.

IoT용 Azure Security Center는 모듈 쌍 메커니즘을 사용하고, 각 디바이스에 azureiotsecurity라고 하는 보안 모듈 쌍을 유지 관리합니다.

보안 모듈 쌍은 각 디바이스의 디바이스 보안과 관련된 모든 정보를 보유합니다.

IoT용 Azure Security Center 기능을 최대한 활용하려면 새 IoT Edge 디바이스에 이러한 보안 모듈 쌍을 만들고 구성하고 사용해야 합니다.

보안 모듈 쌍 **azureiotsecurity**는 두 가지 방법으로 만들 수 있습니다.

* [모듈 배치 스크립트](https://github.com/Azure/Azure-IoT-Security/tree/master/security_module_twin) - 는 기본 구성을 사용하여 모듈 쌍이 없는 새 디바이스 또는 디바이스의 모듈 쌍을 자동으로 생성합니다.
* 각 디바이스를 위한 특정 구성으로 각각의 모듈 쌍을 수동으로 개별 편집합니다.

이 작업에서는 수동으로 보안 모듈 쌍을 만듭니다.

#### 연습 6: IoT용 Azure Security Center C# 보안 에이전트 배포

IoT용 Azure Security Center는 IoT Hub를 통해 보안 데이터를 로그하고, 처리하고, 집계하고, 보내는 보안 에이전트의 참조 아키텍처를 제공합니다. 시뮬레이션된 디바이스(Linux VM)에 배포할 C#용 보안 에이전트를 추가합니다. C 및 C# 기반 에이전트가 있습니다. C 에이전트는 좀 더 제한적이거나 최소한의 디바이스 리소스가 있는 디바이스에 권장됩니다.

보안 에이전트는 다음 기능을 지원합니다.

* 기본 운영 체제(Linux, Windows)에서 원시 보안 이벤트를 수집합니다. 사용 가능한 보안 데이터 수집기에 대한 자세한 내용은 IoT 에이전트용 Azure Security Center 구성을 참조하세요.
* 원시 보안 이벤트를 IoT Hub를 통해 전송된 메시지로 집계합니다.
* 기존의 디바이스 ID 또는 전용 모듈 ID로 인증합니다. 자세한 내용은 보안 에이전트 인증 방법을 참조하세요.
* **azureiotsecurity** 모듈 쌍을 사용하여 원격으로 구성합니다. 자세한 내용은 IoT 에이전트용 Azure Security Center 구성을 참조하세요.

#### 연습 7: 솔루션 관리 구성

IoT용 Azure Security Center는 Azure 기반 IoT 솔루션에 광범위한 종단 간 보안을 제공합니다.

IoT용 Azure Security Center를 사용하면 하나의 대시보드에서 전체 IoT 솔루션을 모니터링하여 Azure의 모든 IoT 디바이스, IoT 플랫폼 및 백 엔드 리소스를 표시할 수 있습니다.

IoT Hub에서 활성화되면 IoT용 Azure Security Center는 다른 Azure 서비스를 자동으로 식별하고 IoT Hub에 연결되어 있으며, IoT 솔루션과 관련되어 있습니다.

자동 관계 검색 외에도 IoT 솔루션의 일부로 태그할 다른 Azure 리소스 그룹을 선택할 수도 있습니다. 선택을 통해 전체 구독, 리소스 그룹 또는 단일 리소스를 추가할 수 있습니다.

## LAB_AK_20

### 랩 시나리오

Azure IoT Central을 사용하면 원격 디바이스들을 쉽게 모니터링하고 관리할 수 있습니다.

Azure IoT Central은 훌륭하게 작동하지만 많은 기술이 필요할 때 구현하기가 복잡할 수 있는 다양한 기본 기술을 포함하고 있습니다. 이러한 기술에는 Azure IoT Hub, Azure DPS(디바이스 프로비저닝 시스템), Azure Maps, Azure Time Series Insights, Azure IoT Edge 등이 포함됩니다. IoT Central을 통해 사용할 수 있는 것보다 더 많은 세분성이 필요한 경우에만 이러한 기술을 직접 사용해야 합니다.

이 랩의 목적 중 하나는 필요한 시나리오를 지원하기 위해 IoT Central에 충분한 기능이 있는지 여부를 결정하도록 도움을 주는 것입니다. 그럼 IoT Central이 재미있고 관련된 시나리오로 무엇을 할 수 있는지 살펴보겠습니다.

Contoso는 냉장 트럭들을 운영합니다. 도시에는 많은 고객이 있고 운영 기지도 있습니다. 각 트럭에게 내용물을 고객에게 배달하도록 지시합니다. 그러나 트럭 중 한 대에서 냉동 시스템이 고장날 수 있으며, 내용물이 녹기 시작하면 트럭에게 기지로 돌아가서 내용물을 버리라고 지시해야 합니다. 또는 내용물이 녹고 있다는 것을 알게 되면 트럭과 가장 가까운 곳에 있는 다른 고객에게 내용물을 전달할 수 있습니다.

이러한 결정을 내리려면 트럭에서 일어나는 모든 일을 알아야 합니다. 지도에서 각 트럭의 위치, 냉동 시스템의 상태 및 내용물의 상태를 알아야 합니다.

IoT Central은 이러한 시나리오를 처리하는 데 필요한 모든 것을 제공합니다. 

#### 연습 1: 사용자 지정 IoT Central 앱 만들기

[TBD]

#### 연습 2: 디바이스 템플릿 만들기

원격 디바이스와 IoT Central 간에 통신되는 데이터는 _디바이스 템플릿_에 지정됩니다. 디바이스 템플릿은 데이터의 모든 세부 정보를 캡슐화하므로 디바이스와 IoT Central이 통신을 이해하는 데 필요한 모든 것을 가지고 있습니다.

이 랩에서는 냉동 트럭을 위한 디바이스 템플릿을 만듭니다.

#### 연습 3: 시뮬레이션된 디바이스 모니터링

먼저 디바이스 템플릿의 모든 기능을 보여주는 대시보드를 만듭니다. 그런 다음, 실제 디바이스를 만들고 원격 디바이스 앱에 필요한 연결 설정을 기록합니다.

#### 연습 4: 무료 Azure Maps 계정 만들기

Azure Maps 계정이 아직 없는 경우 계정을 만들어야 합니다.

#### 연습 5: 실제 디바이스용 프로그래밍 프로젝트 만들기

이 작업에서는 냉동 트럭에서 센서 디바이스를 시뮬레이션하는 프로그래밍 프로젝트를 만듭니다. 이 시뮬레이션을 사용하면 실제 트럭이 필요해지기 훨씬 전에 코드를 테스트할 수 있습니다!

IoT Central은 디바이스 앱과 IoT Central 앱 간의 통신 코드가 실제 트럭에 동일하기 때문에 이 시뮬레이션을 "실제"로 처리합니다. 즉, 냉동 트럭 회사를 운영하는 경우 이 작업의 코드와 유사한 시뮬레이션된 코드로 시작합니다. 이 코드가 만족스럽게 작동하면 시뮬레이션 관련 코드가 센서 데이터를 수신하는 코드로 대체됩니다. 이 제한된 업데이트는 다음 코드를 작성하는 것을 소중한 경험으로 만듭니다.

#### 연습 6: IoT Central 디바이스 테스트

이 작업을 수행하는 것은 IoT Central 개발에서 흥미로운 시간입니다! 마지막으로 만들었던 모든 움직이는 부분이 함께 작동하는지 확인합니다.

#### 연습 7: 여러 디바이스 만들기

이 작업에서는 시스템에 여러 대의 트럭을 추가하는 데 필요한 단계를 고려합니다.


